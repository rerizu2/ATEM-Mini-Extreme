<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ATEM Mini Extreme ISOã€ã‚¢ãƒ‹ãƒ¡è¨­å®šåˆ¥çª“å¯¾å¿œç‰ˆã€‘</title>
<style>
body {
  display:flex; justify-content:center; align-items:center; flex-direction:column;
  height:100vh; margin:0; background:black; color:white;
  font-family:sans-serif; overflow:hidden;
}
h1 { margin-top:10px; }
.container {
  display:grid; grid-template-columns:1fr 1fr; grid-template-rows:1fr 1fr;
  width:80vw; height:80vh; border:2px solid white; position:relative;
}
.cell { border:1px solid gray; position:relative; overflow:hidden; }
video { width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0; }
.label {
  position:absolute; top:5px; left:5px; color:white; font-size:20px;
  background:rgba(0,0,0,0.5); padding:5px; border-radius:5px; z-index:2;
}
.horizontal-line, .vertical-line { position:absolute; background:white; z-index:2; }
.horizontal-line { top:50%; left:0; width:100%; height:2px; }
.vertical-line { top:0; left:50%; width:2px; height:100%; }
.split-area { position:absolute; width:50%; height:50%; overflow:hidden; }
.split-area.top-left { top:0; left:0; }
.split-area.bottom-left { bottom:0; left:0; }
.split-area.top-right { top:0; right:0; }
.split-area.bottom-right { bottom:0; right:0; }
.button-group {
  position:absolute; bottom:5px; left:5px; z-index:2;
  display:flex; gap:5px;
}
.button-group button {
  padding:4px 8px; font-size:14px; cursor:pointer; transition:transform 0.2s;
}
.button-group button:hover { transform:scale(1.1); background:#444; }

/* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾© */
@keyframes fadeEffect {0%{opacity:0;}100%{opacity:1;}}
@keyframes zoomEffect {0%{transform:scale(0.8);opacity:0;}100%{transform:scale(1);opacity:1;}}
@keyframes slideEffect {0%{transform:translateX(-100%);opacity:0;}100%{transform:translateX(0);opacity:1;}}
@keyframes rotateEffect {0%{transform:rotate(-180deg);opacity:0;}100%{transform:rotate(0);opacity:1;}}
</style>
</head>

<body>
<h1>ãƒ‡ãƒã‚¤ã‚¹æ¥ç¶š</h1>
<select id="screenCaptureSelect">
  <option value="1">ç”»é¢1</option>
  <option value="2">ç”»é¢2</option>
  <option value="3">ç”»é¢3</option>
  <option value="4">ç”»é¢4</option>
  <option value="5">ç”»é¢5</option>
  <option value="6">ç”»é¢6</option>
  <option value="7">ç”»é¢7</option>
</select>
<button id="startScreenCaptureButton">ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£</button>
<button id="startCameraButton">ã‚«ãƒ¡ãƒ©</button>
<button id="openLiveWindowBtn">ğŸ¬ LIVEæ“ä½œï¼ˆåˆ¥ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼‰</button>

<!-- ğŸ¥ ä¸€æ‹¬éŒ²ç”»ãƒœã‚¿ãƒ³ -->
<div style="margin-top:10px;">
  <button id="startAllRecordBtn">ğŸ¥ 8ç”»é¢åŒæ™‚éŒ²ç”»é–‹å§‹</button>
  <button id="stopAllRecordBtn" style="display:none;">â¹ åœæ­¢ï¼†ä¿å­˜</button>
</div>

<div class="container" id="mainContainer">
  <!-- ğŸ”¹å·¦ä¸Š å‡ºåŠ› -->
  <div class="cell" id="outputCell">
    <div class="label">å‡ºåŠ›</div>
    <video id="switchVideo1" autoplay playsinline></video>
  </div>

  <!-- ğŸ”¹å³ä¸Š -->
  <div class="cell">
    <div class="label">ç”»é¢3ï¼ˆå³ä¸Šï¼‰</div>
    <div class="horizontal-line"></div><div class="vertical-line"></div>
    <div class="split-area top-left"><video id="captureVideo1" autoplay playsinline></video></div>
    <div class="split-area bottom-left"><video id="captureVideo2" autoplay playsinline></video></div>
    <div class="split-area top-right"><video id="captureVideo3" autoplay playsinline></video></div>
    <div class="split-area bottom-right"><video id="captureVideo4" autoplay playsinline></video></div>
  </div>

  <!-- ğŸ”¹å·¦ä¸‹ -->
  <div class="cell">
    <div class="label">ç”»é¢4ï¼ˆå·¦ä¸‹ï¼‰</div>
    <div class="horizontal-line"></div><div class="vertical-line"></div>
    <div class="split-area top-left"><video id="captureVideo5" autoplay playsinline></video></div>
    <div class="split-area bottom-left"><video id="captureVideo6" autoplay playsinline></video></div>
    <div class="split-area top-right"><video id="captureVideo7" autoplay playsinline></video></div>
    <div class="split-area bottom-right"><video id="cameraVideo" autoplay playsinline></video></div>
    <div class="button-group">
      <button onclick="switchSource(5)">5</button>
      <button onclick="switchSource(6)">6</button>
      <button onclick="switchSource(7)">7</button>
      <button onclick="switchSource('camera')">8</button>
    </div>
  </div>

  <!-- ğŸ”¹å³ä¸‹ -->
  <div class="cell"><div class="label">äºˆå‚™</div><video id="previewVideo" autoplay playsinline muted></video></div>
</div>

<script>
const videoElements = {
  1: captureVideo1, 2: captureVideo2, 3: captureVideo3, 4: captureVideo4,
  5: captureVideo5, 6: captureVideo6, 7: captureVideo7, camera: cameraVideo
};
const switchVideo = document.getElementById("switchVideo1");
const previewVideo = document.getElementById("previewVideo");
let liveWindow = null;
let liveAnimType = 'fadeEffect';
let liveAnimSpeed = '1s';

// ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨
function playAnim(el, type, speed) {
  el.style.animation = 'none';
  void el.offsetWidth;
  el.style.animation = `${type} ${speed} ease`;
}

// åŒæœŸé–¢æ•°
function syncAll() {
  if (!liveWindow || liveWindow.closed) return;
  const lt = liveWindow.document.getElementById("liveCaptureVideo1");
  const ltWrap = liveWindow.document.getElementById("liveLTWrapper");
  if (lt && switchVideo.srcObject) {
    lt.srcObject = switchVideo.srcObject;
    if (ltWrap) playAnim(ltWrap, liveAnimType, liveAnimSpeed);
  }
  ['captureVideo1','captureVideo2','captureVideo3','captureVideo4'].forEach((id,i)=>{
    const v=document.getElementById(id);
    const lv=liveWindow.document.getElementById(`liveRU${i+1}`);
    if(v&&v.srcObject)lv.srcObject=v.srcObject;
  });
  ['captureVideo5','captureVideo6','captureVideo7','cameraVideo'].forEach((id,i)=>{
    const v=document.getElementById(id);
    const lv=liveWindow.document.getElementById(`liveLD${i+1}`);
    if(v&&v.srcObject)lv.srcObject=v.srcObject;
  });
  const rb = liveWindow.document.getElementById("liveRD1");
  if (rb && previewVideo.srcObject) rb.srcObject = previewVideo.srcObject;
}

// å‡ºåŠ›åˆ‡æ›¿
function switchSource(id) {
  const srcVideo = videoElements[id];
  if (!srcVideo || !srcVideo.srcObject) return;

  switchVideo.srcObject = srcVideo.srcObject;
  previewVideo.srcObject = srcVideo.srcObject;
  playAnim(switchVideo, liveAnimType, liveAnimSpeed);

  if (liveWindow && !liveWindow.closed) {
    const liveLeftTop = liveWindow.document.getElementById("liveCaptureVideo1");
    const liveWrap = liveWindow.document.getElementById("liveLTWrapper");
    if (liveLeftTop) liveLeftTop.srcObject = srcVideo.srcObject;
    if (liveWrap) playAnim(liveWrap, liveAnimType, liveAnimSpeed);
  }
}

// ã‚­ãƒ£ãƒ—ãƒãƒ£é–‹å§‹
startScreenCaptureButton.onclick = () => {
  const id = screenCaptureSelect.value;
  const v = videoElements[id];
  if (!v) return;
  navigator.mediaDevices.getDisplayMedia({video:true})
  .then(s => { v.srcObject = s; syncAll(); })
  .catch(console.error);
};

// ã‚«ãƒ¡ãƒ©èµ·å‹•
startCameraButton.onclick = () => {
  navigator.mediaDevices.getUserMedia({video:true})
  .then(s => { videoElements.camera.srcObject = s; syncAll(); })
  .catch(console.error);
};

// LIVEã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ç”Ÿæˆ
openLiveWindowBtn.onclick = () => {
  liveWindow = window.open("", "livePanel", "width=1280,height=800");
  if (!liveWindow) return alert("ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¨±å¯ã—ã¦ãã ã•ã„");

  liveWindow.document.title = "ğŸ¬ LIVEæ“ä½œãƒ‘ãƒãƒ«";
  liveWindow.document.body.style.background = "black";
  liveWindow.document.body.style.color = "white";
  liveWindow.document.body.innerHTML = `
    <h3 style="text-align:center;">ğŸ¬ LIVEæ“ä½œãƒ‘ãƒãƒ«</h3>

    <div style="text-align:center;margin:10px;">
      ${[1,2,3,4,5,6,7,'camera'].map(i=>`<button data-id="${i}">åˆ‡æ›¿${i}</button>`).join('')}
    </div>

    <div style="text-align:center;margin:10px;">
      <label>ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³:
        <select id="animType">
          <option value="fadeEffect" selected>ãƒ•ã‚§ãƒ¼ãƒ‰</option>
          <option value="zoomEffect">ã‚ºãƒ¼ãƒ </option>
          <option value="slideEffect">ã‚¹ãƒ©ã‚¤ãƒ‰</option>
          <option value="rotateEffect">å›è»¢</option>
        </select>
      </label>
      <label>é€Ÿåº¦:
        <select id="animSpeed">
          <option value="0.5s">0.5ç§’</option>
          <option value="1s" selected>1ç§’</option>
          <option value="2s">2ç§’</option>
        </select>
      </label>
    </div>

    <div id="liveContainer" style="position:relative;width:90%;height:500px;margin:20px auto;border:3px solid white;">
      <div id="liveLTWrapper" style="position:absolute;top:0;left:0;width:50%;height:50%;border:1px solid white;">
        <video id="liveCaptureVideo1" autoplay muted style="width:100%;height:100%;object-fit:cover;"></video>
      </div>

      <div style="position:absolute;top:0;right:0;width:50%;height:50%;border:1px solid white;">
        ${[1,2,3,4].map(i=>`
          <video id="liveRU${i}" autoplay muted style="width:50%;height:50%;object-fit:cover;position:absolute;
          ${i<3?'top:0;':'bottom:0;'}${i%2==1?'left:0;':'right:0;'}"></video>`).join('')}
      </div>

      <div style="position:absolute;bottom:0;left:0;width:50%;height:50%;border:1px solid white;">
        ${[1,2,3,4].map(i=>`
          <video id="liveLD${i}" autoplay muted style="width:50%;height:50%;object-fit:cover;position:absolute;
          ${i<3?'top:0;':'bottom:0;'}${i%2==1?'left:0;':'right:0;'}"></video>`).join('')}
      </div>

      <div style="position:absolute;bottom:0;right:0;width:50%;height:50%;border:1px solid white;">
        <video id="liveRD1" autoplay muted style="width:100%;height:100%;object-fit:cover;"></video>
      </div>
    </div>`;

  const typeSel = liveWindow.document.getElementById("animType");
  const speedSel = liveWindow.document.getElementById("animSpeed");
  typeSel.onchange = () => liveAnimType = typeSel.value;
  speedSel.onchange = () => liveAnimSpeed = speedSel.value;

  liveWindow.document.querySelectorAll("button[data-id]").forEach(btn=>{
    btn.onclick = () => switchSource(btn.dataset.id);
  });

  syncAll();
};

// Qã‚­ãƒ¼ã§å…¨ç”»é¢ï¼ˆãƒ¡ã‚¤ãƒ³å…¨ä½“ï¼‰
document.addEventListener("keydown", e=>{
  if(e.key==="q"||e.key==="Q"){
    const container=document.getElementById("mainContainer");
    if(!document.fullscreenElement) container.requestFullscreen();
    else document.exitFullscreen();
  }
});

// Wã‚­ãƒ¼ã§å‡ºåŠ›ç”»é¢ã®ã¿å…¨ç”»é¢
document.addEventListener("keydown", e=>{
  if(e.key==="w"||e.key==="W"){
    const outputCell=document.getElementById("outputCell");
    if(!document.fullscreenElement) outputCell.requestFullscreen();
    else document.exitFullscreen();
  }
});

// ğŸ¥ ä¸€æ‹¬éŒ²ç”»æ©Ÿèƒ½ =========================================
const recordTargets = [
  { id: 'captureVideo1', name: 'ç”»é¢3_å·¦ä¸Š' },
  { id: 'captureVideo2', name: 'ç”»é¢3_å·¦ä¸‹' },
  { id: 'captureVideo3', name: 'ç”»é¢3_å³ä¸Š' },
  { id: 'captureVideo4', name: 'ç”»é¢3_å³ä¸‹' },
  { id: 'captureVideo5', name: 'ç”»é¢4_å·¦ä¸Š' },
  { id: 'captureVideo6', name: 'ç”»é¢4_å·¦ä¸‹' },
  { id: 'captureVideo7', name: 'ç”»é¢4_å³ä¸Š' },
  { id: 'cameraVideo',  name: 'ç”»é¢4_å³ä¸‹ï¼ˆã‚«ãƒ¡ãƒ©ï¼‰' }
];

let recorders = [];
let recordedChunks = [];

document.getElementById("startAllRecordBtn").onclick = () => {
  recorders = [];
  recordedChunks = [];

  recordTargets.forEach((target) => {
    const video = document.getElementById(target.id);
    if (!video || !video.srcObject) return;

    const stream = video.srcObject;
    const recorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp9' });
    const chunks = [];
    recorder.ondataavailable = e => e.data.size > 0 && chunks.push(e.data);
    recorder.onstop = () => {
      const blob = new Blob(chunks, { type: 'video/webm' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${target.name}_${new Date().toISOString().replace(/[:.]/g,'-')}.webm`;
      a.click();
      URL.revokeObjectURL(url);
    };
    recorder.start();
    recorders.push(recorder);
    recordedChunks.push(chunks);
  });

  alert("ğŸ¥ 8ç”»é¢ã®éŒ²ç”»ã‚’é–‹å§‹ã—ã¾ã—ãŸï¼");
  document.getElementById("startAllRecordBtn").style.display = "none";
  document.getElementById("stopAllRecordBtn").style.display = "inline-block";
};

document.getElementById("stopAllRecordBtn").onclick = () => {
  recorders.forEach(r => r && r.state === "recording" && r.stop());
  alert("â¹ ã™ã¹ã¦ã®éŒ²ç”»ã‚’åœæ­¢ã—ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
  document.getElementById("startAllRecordBtn").style.display = "inline-block";
  document.getElementById("stopAllRecordBtn").style.display = "none";
};
</script>
</body>
</html>
