<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ATEM Mini Extreme ISO【アニメ設定別窓対応版】</title>
<style>
body {
  display:flex; justify-content:center; align-items:center; flex-direction:column;
  height:100vh; margin:0; background:black; color:white;
  font-family:sans-serif; overflow:hidden;
}
h1 { margin-top:10px; }
.container {
  display:grid; grid-template-columns:1fr 1fr; grid-template-rows:1fr 1fr;
  width:80vw; height:80vh; border:2px solid white; position:relative;
}
.cell { border:1px solid gray; position:relative; overflow:hidden; }
video { width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0; }
.label {
  position:absolute; top:5px; left:5px; color:white; font-size:20px;
  background:rgba(0,0,0,0.5); padding:5px; border-radius:5px; z-index:2;
}
.horizontal-line, .vertical-line { position:absolute; background:white; z-index:2; }
.horizontal-line { top:50%; left:0; width:100%; height:2px; }
.vertical-line { top:0; left:50%; width:2px; height:100%; }
.split-area { position:absolute; width:50%; height:50%; overflow:hidden; }
.split-area.top-left { top:0; left:0; }
.split-area.bottom-left { bottom:0; left:0; }
.split-area.top-right { top:0; right:0; }
.split-area.bottom-right { bottom:0; right:0; }
.button-group {
  position:absolute; bottom:5px; left:5px; z-index:2;
  display:flex; gap:5px;
}
.button-group button {
  padding:4px 8px; font-size:14px; cursor:pointer; transition:transform 0.2s;
}
.button-group button:hover { transform:scale(1.1); background:#444; }

/* アニメーション定義 */
@keyframes fadeEffect {0%{opacity:0;}100%{opacity:1;}}
@keyframes zoomEffect {0%{transform:scale(0.8);opacity:0;}100%{transform:scale(1);opacity:1;}}
@keyframes slideEffect {0%{transform:translateX(-100%);opacity:0;}100%{transform:translateX(0);opacity:1;}}
@keyframes rotateEffect {0%{transform:rotate(-180deg);opacity:0;}100%{transform:rotate(0);opacity:1;}}
</style>
</head>

<body>
<h1>デバイス接続</h1>
<select id="screenCaptureSelect">
  <option value="1">画面1</option>
  <option value="2">画面2</option>
  <option value="3">画面3</option>
  <option value="4">画面4</option>
  <option value="5">画面5</option>
  <option value="6">画面6</option>
  <option value="7">画面7</option>
</select>
<button id="startScreenCaptureButton">画面キャプチャ</button>
<button id="startCameraButton">カメラ</button>
<button id="openLiveWindowBtn">🎬 LIVE操作（別ウィンドウ）</button>

<!-- 🎥 一括録画ボタン -->
<div style="margin-top:10px;">
  <button id="startAllRecordBtn">🎥 8画面同時録画開始</button>
  <button id="stopAllRecordBtn" style="display:none;">⏹ 停止＆保存</button>
</div>

<div class="container" id="mainContainer">
  <!-- 🔹左上 出力 -->
  <div class="cell" id="outputCell">
    <div class="label">出力</div>
    <video id="switchVideo1" autoplay playsinline></video>
  </div>

  <!-- 🔹右上 -->
  <div class="cell">
    <div class="label">画面3（右上）</div>
    <div class="horizontal-line"></div><div class="vertical-line"></div>
    <div class="split-area top-left"><video id="captureVideo1" autoplay playsinline></video></div>
    <div class="split-area bottom-left"><video id="captureVideo2" autoplay playsinline></video></div>
    <div class="split-area top-right"><video id="captureVideo3" autoplay playsinline></video></div>
    <div class="split-area bottom-right"><video id="captureVideo4" autoplay playsinline></video></div>
  </div>

  <!-- 🔹左下 -->
  <div class="cell">
    <div class="label">画面4（左下）</div>
    <div class="horizontal-line"></div><div class="vertical-line"></div>
    <div class="split-area top-left"><video id="captureVideo5" autoplay playsinline></video></div>
    <div class="split-area bottom-left"><video id="captureVideo6" autoplay playsinline></video></div>
    <div class="split-area top-right"><video id="captureVideo7" autoplay playsinline></video></div>
    <div class="split-area bottom-right"><video id="cameraVideo" autoplay playsinline></video></div>
    <div class="button-group">
      <button onclick="switchSource(5)">5</button>
      <button onclick="switchSource(6)">6</button>
      <button onclick="switchSource(7)">7</button>
      <button onclick="switchSource('camera')">8</button>
    </div>
  </div>

  <!-- 🔹右下 -->
  <div class="cell"><div class="label">予備</div><video id="previewVideo" autoplay playsinline muted></video></div>
</div>

<script>
const videoElements = {
  1: captureVideo1, 2: captureVideo2, 3: captureVideo3, 4: captureVideo4,
  5: captureVideo5, 6: captureVideo6, 7: captureVideo7, camera: cameraVideo
};
const switchVideo = document.getElementById("switchVideo1");
const previewVideo = document.getElementById("previewVideo");
let liveWindow = null;
let liveAnimType = 'fadeEffect';
let liveAnimSpeed = '1s';

// アニメーション適用
function playAnim(el, type, speed) {
  el.style.animation = 'none';
  void el.offsetWidth;
  el.style.animation = `${type} ${speed} ease`;
}

// 同期関数
function syncAll() {
  if (!liveWindow || liveWindow.closed) return;
  const lt = liveWindow.document.getElementById("liveCaptureVideo1");
  const ltWrap = liveWindow.document.getElementById("liveLTWrapper");
  if (lt && switchVideo.srcObject) {
    lt.srcObject = switchVideo.srcObject;
    if (ltWrap) playAnim(ltWrap, liveAnimType, liveAnimSpeed);
  }
  ['captureVideo1','captureVideo2','captureVideo3','captureVideo4'].forEach((id,i)=>{
    const v=document.getElementById(id);
    const lv=liveWindow.document.getElementById(`liveRU${i+1}`);
    if(v&&v.srcObject)lv.srcObject=v.srcObject;
  });
  ['captureVideo5','captureVideo6','captureVideo7','cameraVideo'].forEach((id,i)=>{
    const v=document.getElementById(id);
    const lv=liveWindow.document.getElementById(`liveLD${i+1}`);
    if(v&&v.srcObject)lv.srcObject=v.srcObject;
  });
  const rb = liveWindow.document.getElementById("liveRD1");
  if (rb && previewVideo.srcObject) rb.srcObject = previewVideo.srcObject;
}

// 出力切替
function switchSource(id) {
  const srcVideo = videoElements[id];
  if (!srcVideo || !srcVideo.srcObject) return;

  switchVideo.srcObject = srcVideo.srcObject;
  previewVideo.srcObject = srcVideo.srcObject;
  playAnim(switchVideo, liveAnimType, liveAnimSpeed);

  if (liveWindow && !liveWindow.closed) {
    const liveLeftTop = liveWindow.document.getElementById("liveCaptureVideo1");
    const liveWrap = liveWindow.document.getElementById("liveLTWrapper");
    if (liveLeftTop) liveLeftTop.srcObject = srcVideo.srcObject;
    if (liveWrap) playAnim(liveWrap, liveAnimType, liveAnimSpeed);
  }
}

// キャプチャ開始
startScreenCaptureButton.onclick = () => {
  const id = screenCaptureSelect.value;
  const v = videoElements[id];
  if (!v) return;
  navigator.mediaDevices.getDisplayMedia({video:true})
  .then(s => { v.srcObject = s; syncAll(); })
  .catch(console.error);
};

// カメラ起動
startCameraButton.onclick = () => {
  navigator.mediaDevices.getUserMedia({video:true})
  .then(s => { videoElements.camera.srcObject = s; syncAll(); })
  .catch(console.error);
};

// LIVEウィンドウ生成
openLiveWindowBtn.onclick = () => {
  liveWindow = window.open("", "livePanel", "width=1280,height=800");
  if (!liveWindow) return alert("ポップアップを許可してください");

  liveWindow.document.title = "🎬 LIVE操作パネル";
  liveWindow.document.body.style.background = "black";
  liveWindow.document.body.style.color = "white";
  liveWindow.document.body.innerHTML = `
    <h3 style="text-align:center;">🎬 LIVE操作パネル</h3>

    <div style="text-align:center;margin:10px;">
      ${[1,2,3,4,5,6,7,'camera'].map(i=>`<button data-id="${i}">切替${i}</button>`).join('')}
    </div>

    <div style="text-align:center;margin:10px;">
      <label>アニメーション:
        <select id="animType">
          <option value="fadeEffect" selected>フェード</option>
          <option value="zoomEffect">ズーム</option>
          <option value="slideEffect">スライド</option>
          <option value="rotateEffect">回転</option>
        </select>
      </label>
      <label>速度:
        <select id="animSpeed">
          <option value="0.5s">0.5秒</option>
          <option value="1s" selected>1秒</option>
          <option value="2s">2秒</option>
        </select>
      </label>
    </div>

    <div id="liveContainer" style="position:relative;width:90%;height:500px;margin:20px auto;border:3px solid white;">
      <div id="liveLTWrapper" style="position:absolute;top:0;left:0;width:50%;height:50%;border:1px solid white;">
        <video id="liveCaptureVideo1" autoplay muted style="width:100%;height:100%;object-fit:cover;"></video>
      </div>

      <div style="position:absolute;top:0;right:0;width:50%;height:50%;border:1px solid white;">
        ${[1,2,3,4].map(i=>`
          <video id="liveRU${i}" autoplay muted style="width:50%;height:50%;object-fit:cover;position:absolute;
          ${i<3?'top:0;':'bottom:0;'}${i%2==1?'left:0;':'right:0;'}"></video>`).join('')}
      </div>

      <div style="position:absolute;bottom:0;left:0;width:50%;height:50%;border:1px solid white;">
        ${[1,2,3,4].map(i=>`
          <video id="liveLD${i}" autoplay muted style="width:50%;height:50%;object-fit:cover;position:absolute;
          ${i<3?'top:0;':'bottom:0;'}${i%2==1?'left:0;':'right:0;'}"></video>`).join('')}
      </div>

      <div style="position:absolute;bottom:0;right:0;width:50%;height:50%;border:1px solid white;">
        <video id="liveRD1" autoplay muted style="width:100%;height:100%;object-fit:cover;"></video>
      </div>
    </div>`;

  const typeSel = liveWindow.document.getElementById("animType");
  const speedSel = liveWindow.document.getElementById("animSpeed");
  typeSel.onchange = () => liveAnimType = typeSel.value;
  speedSel.onchange = () => liveAnimSpeed = speedSel.value;

  liveWindow.document.querySelectorAll("button[data-id]").forEach(btn=>{
    btn.onclick = () => switchSource(btn.dataset.id);
  });

  syncAll();
};

// Qキーで全画面（メイン全体）
document.addEventListener("keydown", e=>{
  if(e.key==="q"||e.key==="Q"){
    const container=document.getElementById("mainContainer");
    if(!document.fullscreenElement) container.requestFullscreen();
    else document.exitFullscreen();
  }
});

// Wキーで出力画面のみ全画面
document.addEventListener("keydown", e=>{
  if(e.key==="w"||e.key==="W"){
    const outputCell=document.getElementById("outputCell");
    if(!document.fullscreenElement) outputCell.requestFullscreen();
    else document.exitFullscreen();
  }
});

// 🎥 一括録画機能 =========================================
const recordTargets = [
  { id: 'captureVideo1', name: '画面3_左上' },
  { id: 'captureVideo2', name: '画面3_左下' },
  { id: 'captureVideo3', name: '画面3_右上' },
  { id: 'captureVideo4', name: '画面3_右下' },
  { id: 'captureVideo5', name: '画面4_左上' },
  { id: 'captureVideo6', name: '画面4_左下' },
  { id: 'captureVideo7', name: '画面4_右上' },
  { id: 'cameraVideo',  name: '画面4_右下（カメラ）' }
];

let recorders = [];
let recordedChunks = [];

document.getElementById("startAllRecordBtn").onclick = () => {
  recorders = [];
  recordedChunks = [];

  recordTargets.forEach((target) => {
    const video = document.getElementById(target.id);
    if (!video || !video.srcObject) return;

    const stream = video.srcObject;
    const recorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp9' });
    const chunks = [];
    recorder.ondataavailable = e => e.data.size > 0 && chunks.push(e.data);
    recorder.onstop = () => {
      const blob = new Blob(chunks, { type: 'video/webm' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${target.name}_${new Date().toISOString().replace(/[:.]/g,'-')}.webm`;
      a.click();
      URL.revokeObjectURL(url);
    };
    recorder.start();
    recorders.push(recorder);
    recordedChunks.push(chunks);
  });

  alert("🎥 8画面の録画を開始しました！");
  document.getElementById("startAllRecordBtn").style.display = "none";
  document.getElementById("stopAllRecordBtn").style.display = "inline-block";
};

document.getElementById("stopAllRecordBtn").onclick = () => {
  recorders.forEach(r => r && r.state === "recording" && r.stop());
  alert("⏹ すべての録画を停止し、ファイルを保存しました。");
  document.getElementById("startAllRecordBtn").style.display = "inline-block";
  document.getElementById("stopAllRecordBtn").style.display = "none";
};
</script>
</body>
</html>
